import React, { useState, useEffect, useMemo } from 'react';
import { 
  ChevronLeft, 
  ChevronRight, 
  Sunrise, 
  Sun, 
  CloudSun, 
  Sunset, 
  Moon, 
  CheckCircle2, 
  History, 
  XCircle, 
  BarChart3, 
  Calendar as CalendarIcon,
  Trophy,
  Sparkles,
  Loader2,
  Quote,
  Flame,
  SunMedium
} from 'lucide-react';

// --- Constants ---
const APP_ICON_URL = "https://i.ibb.co/ZRjmkWdj/Cream-Orange-Elegant-Mosque-Islamic-Center-Logo.png";

// --- Components ---

const PrayerCard = ({ prayer, status, onUpdate, darkMode }) => {
  const getStatusStyle = (s) => {
    if (darkMode) {
      switch(s) {
        case 'on_time': return 'bg-emerald-950/40 border-emerald-500 text-emerald-100';
        case 'late': return 'bg-amber-950/40 border-amber-500 text-amber-100';
        case 'missed': return 'bg-rose-950/40 border-rose-500 text-rose-100';
        default: return 'bg-slate-900 border-slate-700 text-slate-400 hover:border-emerald-500/50';
      }
    } else {
      switch(s) {
        case 'on_time': return 'bg-emerald-100 border-emerald-500 text-emerald-800';
        case 'late': return 'bg-amber-100 border-amber-500 text-amber-800';
        case 'missed': return 'bg-rose-100 border-rose-500 text-rose-100';
        default: return 'bg-white border-slate-200 text-slate-500 hover:border-emerald-200';
      }
    }
  };

  const getIcon = (name) => {
    switch(name) {
      case 'Fajr': return <Sunrise className="w-6 h-6" />;
      case 'Dhuhr': return <Sun className="w-6 h-6" />;
      case 'Asr': return <CloudSun className="w-6 h-6" />;
      case 'Maghrib': return <Sunset className="w-6 h-6" />;
      case 'Isha': return <Moon className="w-6 h-6" />;
      default: return <Sun className="w-6 h-6" />;
    }
  };

  return (
    <div className={`relative flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 rounded-xl border-2 transition-all duration-300 ${getStatusStyle(status)} shadow-sm mb-3`}>
      <div className="flex items-center gap-4 mb-3 sm:mb-0">
        <div className={`p-2 rounded-full ${status ? 'bg-white/10' : (darkMode ? 'bg-slate-800 text-slate-600' : 'bg-slate-100 text-slate-400')}`}>
          {getIcon(prayer.name)}
        </div>
        <div>
          <h3 className="font-bold text-lg">{prayer.name}</h3>
          <p className="text-xs opacity-75 font-medium">
            {status === 'on_time' && 'Prayed On Time'}
            {status === 'late' && 'Prayed Late (Qadha)'}
            {status === 'missed' && 'Missed'}
            {!status && 'Not logged yet'}
          </p>
        </div>
      </div>

      <div className="flex gap-2 w-full sm:w-auto">
        <button onClick={() => onUpdate('on_time')} className={`flex-1 sm:flex-none flex items-center justify-center gap-1 px-3 py-2 rounded-lg text-sm font-semibold transition-all ${status === 'on_time' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/20' : (darkMode ? 'bg-slate-800 text-slate-300 hover:bg-emerald-900/30' : 'bg-slate-50 text-slate-600 hover:bg-emerald-50')}`}>
          <CheckCircle2 size={16} /><span className="sm:hidden lg:inline text-xs">On Time</span>
        </button>
        <button onClick={() => onUpdate('late')} className={`flex-1 sm:flex-none flex items-center justify-center gap-1 px-3 py-2 rounded-lg text-sm font-semibold transition-all ${status === 'late' ? 'bg-amber-500 text-white shadow-lg shadow-amber-900/20' : (darkMode ? 'bg-slate-800 text-slate-300 hover:bg-amber-900/30' : 'bg-slate-50 text-slate-600 hover:bg-amber-50')}`}>
          <History size={16} /><span className="sm:hidden lg:inline text-xs">Late</span>
        </button>
        <button onClick={() => onUpdate('missed')} className={`flex-1 sm:flex-none flex items-center justify-center gap-1 px-3 py-2 rounded-lg text-sm font-semibold transition-all ${status === 'missed' ? 'bg-rose-500 text-white shadow-lg shadow-rose-900/20' : (darkMode ? 'bg-slate-800 text-slate-300 hover:bg-rose-900/30' : 'bg-slate-50 text-slate-600 hover:bg-amber-50')}`}>
          <XCircle size={16} /><span className="sm:hidden lg:inline text-xs">Missed</span>
        </button>
      </div>
    </div>
  );
};

const StatCard = ({ title, value, icon: Icon, colorClass, darkMode }) => (
  <div className={`${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-100'} p-4 rounded-2xl shadow-sm border flex items-center gap-4`}>
    <div className={`p-3 rounded-xl ${colorClass} bg-opacity-10 text-current`}>
      <Icon className={`w-6 h-6 ${colorClass.replace('bg-', 'text-')}`} />
    </div>
    <div>
      <p className="text-slate-500 text-xs font-bold uppercase tracking-wider">{title}</p>
      <p className={`text-2xl font-bold ${darkMode ? 'text-slate-100' : 'text-slate-800'}`}>{value}</p>
    </div>
  </div>
);

const ReflectionCard = ({ reflection, loading, onGenerate, darkMode }) => (
  <div className={`${darkMode ? 'from-indigo-950/30 to-purple-950/30 border-indigo-900/50' : 'from-indigo-50 to-purple-50 border-indigo-100'} bg-gradient-to-br rounded-2xl p-5 border shadow-sm mt-6 relative overflow-hidden`}>
    <div className="absolute top-0 right-0 p-4 opacity-5 text-indigo-400"><Sparkles size={100} /></div>
    <div className="relative z-10">
      <div className="flex items-center gap-2 mb-3">
        <Sparkles className="text-indigo-400 w-5 h-5" />
        <h3 className={`font-bold ${darkMode ? 'text-indigo-200' : 'text-indigo-900'}`}>AI Spiritual Coach</h3>
      </div>
      {reflection ? (
        <div className="animate-in fade-in slide-in-from-bottom-2">
          <div className="flex gap-3">
            <Quote className="text-indigo-500 w-8 h-8 flex-shrink-0 -mt-1 transform scale-x-[-1] opacity-50" />
            <p className={`leading-relaxed text-sm italic ${darkMode ? 'text-indigo-100' : 'text-indigo-900'}`}>{reflection}</p>
          </div>
          <button onClick={onGenerate} disabled={loading} className="mt-4 text-xs font-semibold text-indigo-400 hover:text-indigo-300 transition-colors flex items-center gap-1">
             <Sparkles size={12} /> Refresh Reflection
          </button>
        </div>
      ) : (
        <div className="text-center py-2">
           <p className={`${darkMode ? 'text-indigo-300/70' : 'text-indigo-800/70'} text-sm mb-4`}>Get a personalized spiritual reflection based on your prayers today.</p>
           <button onClick={onGenerate} disabled={loading} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-md flex items-center justify-center gap-2 w-full sm:w-auto mx-auto">
             {loading ? <Loader2 className="animate-spin w-4 h-4" /> : <Sparkles className="w-4 h-4" />}
             {loading ? 'Reflecting...' : 'Generate Reflection'}
           </button>
        </div>
      )}
    </div>
  </div>
);

const ProgressBar = ({ progress }) => (
  <div className="w-full h-1.5 bg-slate-200 dark:bg-slate-800">
    <div className="h-full bg-emerald-500 transition-all duration-500 ease-out" style={{ width: `${progress}%` }} />
  </div>
);

const MiniCalendar = ({ currentDate, onSelectDate, onClose, records, getDateKey, darkMode }) => {
  const [viewDate, setViewDate] = useState(new Date(currentDate));
  const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
  const firstDayOfMonth = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
  const monthName = viewDate.toLocaleString('default', { month: 'long', year: 'numeric' });

  const handlePrevMonth = () => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() - 1, 1));
  const handleNextMonth = () => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 1));

  const days = [];
  for (let i = 0; i < firstDayOfMonth; i++) days.push(<div key={`empty-${i}`} className="h-8 w-8" />);
  for (let d = 1; d <= daysInMonth; d++) {
    const tempDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
    const dateKey = getDateKey(tempDate);
    const hasData = records[dateKey] && Object.values(records[dateKey]).some(Boolean);
    const isSelected = dateKey === getDateKey(currentDate);
    const isToday = dateKey === getDateKey(new Date());

    days.push(
      <button key={d} onClick={() => { onSelectDate(tempDate); onClose(); }}
        className={`h-8 w-8 rounded-full flex flex-col items-center justify-center text-sm relative transition-colors ${isSelected ? 'bg-emerald-600 text-white font-bold' : (darkMode ? 'hover:bg-slate-800 text-slate-300' : 'hover:bg-slate-100 text-slate-700')} ${isToday && !isSelected ? 'border border-emerald-500 text-emerald-600' : ''}`}>
        <span>{d}</span>
        {hasData && !isSelected && <span className="absolute bottom-1 w-1 h-1 bg-emerald-400 rounded-full"></span>}
      </button>
    );
  }

  return (
    <div className="absolute top-16 left-0 right-0 z-50 mx-4">
      <div className={`${darkMode ? 'bg-slate-900 border-slate-700 shadow-emerald-950/20' : 'bg-white border-slate-100 shadow-xl'} rounded-xl border p-4 animate-in fade-in zoom-in-95 duration-200`}>
        <div className="flex items-center justify-between mb-4">
          <button onClick={handlePrevMonth} className={`p-1 rounded ${darkMode ? 'hover:bg-slate-800 text-slate-400' : 'hover:bg-slate-100'}`}><ChevronLeft size={20} /></button>
          <h3 className={`font-bold ${darkMode ? 'text-slate-100' : 'text-slate-800'}`}>{monthName}</h3>
          <button onClick={handleNextMonth} className={`p-1 rounded ${darkMode ? 'hover:bg-slate-800 text-slate-400' : 'hover:bg-slate-100'}`}><ChevronRight size={20} /></button>
        </div>
        <div className="grid grid-cols-7 gap-1 text-center mb-2">
          {['S','M','T','W','T','F','S'].map(d => <span key={d} className="text-xs font-bold text-slate-500">{d}</span>)}
        </div>
        <div className="grid grid-cols-7 gap-1 place-items-center">{days}</div>
        <button onClick={onClose} className={`w-full mt-4 py-2 text-sm rounded-lg ${darkMode ? 'text-slate-500 hover:bg-slate-800' : 'text-slate-500 hover:bg-slate-50'}`}>Close</button>
      </div>
      <div className="fixed inset-0 z-[-1] bg-black/20 backdrop-blur-[1px]" onClick={onClose} />
    </div>
  );
};

export default function App() {
  const [darkMode, setDarkMode] = useState(() => {
    if (typeof window !== 'undefined') {
      return window.matchMedia('(prefers-color-scheme: dark)').matches;
    }
    return false;
  });

  // --- APP ICON & PWA META INJECTION ---
  useEffect(() => {
    const setHeadTags = () => {
        // Favicon
        let link = document.querySelector("link[rel~='icon']");
        if (!link) {
            link = document.createElement('link');
            link.rel = 'icon';
            link.type = 'image/png';
            document.head.appendChild(link);
        }
        link.href = APP_ICON_URL;

        // Apple Touch Icon (Mobile App Icon)
        let appleLink = document.querySelector("link[rel='apple-touch-icon']");
        if (!appleLink) {
            appleLink = document.createElement('link');
            appleLink.rel = 'apple-touch-icon';
            document.head.appendChild(appleLink);
        }
        appleLink.href = APP_ICON_URL;

        // Mobile App Capable
        let metaMobile = document.querySelector("meta[name='apple-mobile-web-app-capable']");
        if (!metaMobile) {
            metaMobile = document.createElement('meta');
            metaMobile.name = 'apple-mobile-web-app-capable';
            metaMobile.content = 'yes';
            document.head.appendChild(metaMobile);
        }
    };
    
    setHeadTags();
  }, []);

  const [currentDate, setCurrentDate] = useState(new Date());
  const [records, setRecords] = useState({});
  const [view, setView] = useState('daily');
  const [showCalendar, setShowCalendar] = useState(false);
  const [reflection, setReflection] = useState(null);
  const [loadingReflection, setLoadingReflection] = useState(false);

  const prayers = [
    { id: 'fajr', name: 'Fajr' },
    { id: 'dhuhr', name: 'Dhuhr' },
    { id: 'asr', name: 'Asr' },
    { id: 'maghrib', name: 'Maghrib' },
    { id: 'isha', name: 'Isha' },
  ];

  const getDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  const dateKey = useMemo(() => getDateKey(currentDate), [currentDate]);

  const handleUpdateStatus = (prayerId, newStatus) => {
    setRecords(prev => {
      const dayRecord = prev[dateKey] || {};
      const updatedStatus = dayRecord[prayerId] === newStatus ? null : newStatus;
      if (dateKey === getDateKey(new Date())) setReflection(null);
      return { ...prev, [dateKey]: { ...dayRecord, [prayerId]: updatedStatus } };
    });
  };

  const generateReflection = async () => {
    setLoadingReflection(true);
    const apiKey = ""; 
    const todaysData = records[dateKey] || {};
    const summary = prayers.map(p => `${p.name}: ${todaysData[p.id] || 'Not logged'}`).join(', ');
    const prompt = `You are a wise, gentle, and encouraging Islamic spiritual coach. The user logged: ${summary}. Give 2-3 sentences of reflection with emojis. Keep it warm.`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await response.json();
      setReflection(data.candidates?.[0]?.content?.parts?.[0]?.text || "May Allah bless your day. ðŸ¤²");
    } catch (e) {
      setReflection("Unable to connect to coach right now. ðŸ¤²");
    } finally {
      setLoadingReflection(false);
    }
  };

  const stats = useMemo(() => {
    let onTime = 0, late = 0, missed = 0;
    Object.values(records).forEach(day => {
      Object.values(day).forEach(s => {
        if (s === 'on_time') onTime++;
        else if (s === 'late') late++;
        else if (s === 'missed') missed++;
      });
    });

    let streak = 0;
    let checkDate = new Date();
    const isLogged = (d) => {
        const data = records[getDateKey(d)];
        return data && Object.values(data).some(v => v === 'on_time' || v === 'late');
    };
    if (isLogged(checkDate)) streak = 1;
    checkDate.setDate(checkDate.getDate() - 1);
    while (isLogged(checkDate)) {
      streak++;
      checkDate.setDate(checkDate.getDate() - 1);
    }
    return { onTime, late, missed, streak };
  }, [records]);

  const dailyProgress = useMemo(() => {
    const data = records[dateKey] || {};
    const count = Object.values(data).filter(v => v === 'on_time' || v === 'late').length;
    return (count / 5) * 100;
  }, [records, dateKey]);

  const displayDate = new Intl.DateTimeFormat('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).format(currentDate);
  const isToday = getDateKey(new Date()) === dateKey;

  return (
    <div className={`min-h-screen font-sans transition-colors duration-300 pb-10 ${darkMode ? 'bg-black text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
      <header className={`${darkMode ? 'bg-slate-950 border-slate-800' : 'bg-white border-b'} sticky top-0 z-20`}>
        <div className="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-10 h-10 bg-white rounded-xl flex items-center justify-center overflow-hidden border border-slate-200 shadow-sm p-0.5">
               <img src={APP_ICON_URL} alt="Mosque Logo" className="w-full h-full object-contain" />
            </div>
            <h1 className="text-xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-400 bg-clip-text text-transparent">SalahTracker</h1>
          </div>
          <div className="flex items-center gap-1.5">
            <button onClick={() => setDarkMode(!darkMode)} className={`p-2 rounded-lg transition-colors ${darkMode ? 'text-amber-400 hover:bg-slate-900' : 'text-slate-500 hover:bg-slate-100'}`}>
              {darkMode ? <SunMedium size={20} /> : <Moon size={20} />}
            </button>
            <div className={`flex items-center gap-1 px-2 py-1 rounded-full text-sm font-bold border ${darkMode ? 'bg-orange-950/30 text-orange-400 border-orange-900/50' : 'bg-orange-50 text-orange-600 border-orange-100'}`}>
              <Flame size={14} fill="currentColor" /><span>{stats.streak}</span>
            </div>
            <button onClick={() => setView(view === 'daily' ? 'stats' : 'daily')} className={`p-2 rounded-lg transition-colors ${view === 'stats' ? (darkMode ? 'bg-emerald-900/40 text-emerald-400' : 'bg-emerald-100 text-emerald-700') : (darkMode ? 'text-slate-500 hover:bg-slate-900' : 'text-slate-500 hover:bg-slate-100')}`}><BarChart3 size={20} /></button>
          </div>
        </div>
        {view === 'daily' && <ProgressBar progress={dailyProgress} />}
      </header>

      <main className="max-w-md mx-auto p-4 relative">
        {showCalendar && <MiniCalendar currentDate={currentDate} onSelectDate={setCurrentDate} onClose={() => setShowCalendar(false)} records={records} getDateKey={getDateKey} darkMode={darkMode} />}
        
        {view === 'stats' ? (
          <div className="space-y-6 animate-in fade-in">
             <div className="text-center py-2">
                <h2 className={`text-2xl font-bold ${darkMode ? 'text-slate-100' : 'text-slate-800'}`}>Your Journey</h2>
                <p className="text-slate-500 text-sm">Lifetime performance</p>
             </div>
             <div className="grid grid-cols-1 gap-4">
                <StatCard title="On Time" value={stats.onTime} icon={CheckCircle2} colorClass="text-emerald-500 bg-emerald-500" darkMode={darkMode} />
                <StatCard title="Late (Qadha)" value={stats.late} icon={History} colorClass="text-amber-500 bg-amber-500" darkMode={darkMode} />
                <StatCard title="Missed" value={stats.missed} icon={XCircle} colorClass="text-rose-500 bg-rose-500" darkMode={darkMode} />
             </div>

             <div className={`${darkMode ? 'from-emerald-900 to-teal-900 shadow-emerald-950/40' : 'from-emerald-600 to-teal-700 shadow-lg'} bg-gradient-to-br rounded-2xl p-6 text-white relative overflow-hidden`}>
                <div className="absolute top-0 right-0 p-8 opacity-10"><Trophy size={100} /></div>
                <div className="relative z-10">
                  <h3 className="text-lg font-bold mb-2">Daily Reminder</h3>
                  <p className="opacity-90 leading-relaxed italic text-sm">"The most beloved of deeds to Allah are those that are most consistent, even if they are small."</p>
                  <div className="mt-4 pt-4 border-t border-white/20 text-xs opacity-75">Prophet Muhammad (ï·º)</div>
                </div>
             </div>

             <button onClick={() => setView('daily')} className={`w-full py-3 font-medium rounded-lg transition-colors ${darkMode ? 'text-emerald-400 hover:bg-emerald-900/20' : 'text-emerald-600 hover:bg-emerald-50'}`}>Back to Tracker</button>
          </div>
        ) : (
          <div className="space-y-6">
            <div className={`${darkMode ? 'bg-slate-950 border-slate-800 shadow-emerald-950/10' : 'bg-white border shadow-sm'} rounded-2xl p-2 pr-4 flex items-center justify-between sticky top-20 z-10 transition-colors`}>
              <button onClick={() => { const d = new Date(currentDate); d.setDate(d.getDate() - 1); setCurrentDate(d); }} className={`p-3 rounded-xl transition-colors ${darkMode ? 'hover:bg-slate-900 text-slate-500' : 'hover:bg-slate-100 text-slate-500'}`}><ChevronLeft size={20} /></button>
              <div className={`flex flex-col items-center cursor-pointer px-4 py-1 rounded-xl text-center transition-colors ${darkMode ? 'hover:bg-slate-900' : 'hover:bg-slate-50'}`} onClick={() => setShowCalendar(!showCalendar)}>
                <span className={`text-sm font-bold flex items-center gap-2 ${darkMode ? 'text-slate-100' : 'text-slate-800'}`}><CalendarIcon size={14} className="text-emerald-500" />{isToday ? 'Today' : displayDate.split(',')[0]}</span>
                <span className="text-[10px] text-slate-500 uppercase tracking-tight">{displayDate}</span>
              </div>
              <button onClick={() => { const d = new Date(currentDate); d.setDate(d.getDate() + 1); setCurrentDate(d); }} disabled={isToday} className={`p-3 rounded-xl transition-colors ${isToday ? (darkMode ? 'text-slate-800' : 'text-slate-200') : (darkMode ? 'hover:bg-slate-900 text-slate-500' : 'hover:bg-slate-100 text-slate-500')}`}><ChevronRight size={20} /></button>
            </div>
            <div className="space-y-3">
              {prayers.map(p => <PrayerCard key={p.id} prayer={p} status={records[dateKey]?.[p.id]} onUpdate={s => handleUpdateStatus(p.id, s)} darkMode={darkMode} />)}
            </div>
            <ReflectionCard reflection={reflection} loading={loadingReflection} onGenerate={generateReflection} darkMode={darkMode} />
          </div>
        )}
      </main>
    </div>
  );
}
